name: Build & Deploy Server (ARM64)

on:
  push:
    branches:
      - main

jobs:
  check-author:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
    steps:
      - name: Check if author is Snow0406
        id: check
        run: |
          AUTHOR="${{ github.event.pusher.name }}"
          echo "Push author: $AUTHOR"
          if [ "$AUTHOR" == "Snow0406" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "âœ… Authorized: Snow0406"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â›” Unauthorized: Only Snow0406 can trigger server builds"
          fi

  build-and-deploy:
    needs: check-author
    if: needs.check-author.outputs.should-build == 'true'
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # 2. Git LFS íŒŒì¼ ì²´í¬ì•„ì›ƒ
      - name: Checkout Git LFS files
        run: git lfs checkout

      # 3. Unity Library ìºì‹± (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-DedicatedServer-ARM64-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-DedicatedServer-ARM64-
            Library-

      # 4. Unity ë¹Œë“œ (Linux ARM64 Dedicated Server)
      - name: Build Unity Server (ARM64)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          chownFilesTo: runner:docker
          targetPlatform: StandaloneLinux64
          buildMethod: Division.Editor.ServerBuilder.BuildLinuxARM64Server
          customParameters: -standaloneBuildSubtarget Server
          versioning: Semantic
          allowDirtyBuild: true

      # 5. ë¹Œë“œ ê²°ê³¼ë¬¼ ì••ì¶•
      - name: Compress Build
        run: |
          tar -czf Division1D-Server-ARM64.tar.gz -C build/StandaloneLinux64 .

      # 6. Oracle VM SSH í‚¤ ì„¤ì •
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/oracle_key
          chmod 600 ~/.ssh/oracle_key
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts

      # 7. ì„œë²„ ë¹Œë“œ íŒŒì¼ ì „ì†¡ (SCP)
      - name: Transfer Build to Oracle VM
        run: |
          scp -i ~/.ssh/oracle_key \
            Division1D-Server-ARM64.tar.gz \
            ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:~/division1d-build.tar.gz

      # 8. Oracle VMì—ì„œ Podman ì»¨í…Œì´ë„ˆë¡œ ì„œë²„ ì¬ì‹œì‘
      - name: Deploy and Restart Server (Podman)
        run: |
          ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
            set -e

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            echo "ğŸ›‘ Stopping existing container..."
            sudo podman rm -f unityds 2>/dev/null || echo "No running container found"
            sleep 2

            # ì„œë²„ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            echo "ğŸ“¥ Extracting new build..."
            mkdir -p ~/division1d

            # ê¸°ì¡´ íŒŒì¼ ì •ë¦¬ (ë¡œê·¸ëŠ” ìœ ì§€)
            find ~/division1d -type f ! -name "*.log" -delete 2>/dev/null || true

            # ìƒˆ ë¹Œë“œ ì••ì¶• í•´ì œ
            tar -xzf ~/division1d-build.tar.gz -C ~/division1d
            rm ~/division1d-build.tar.gz

            # ì‹¤í–‰ íŒŒì¼ ì°¾ê¸° (Unity ë¹Œë“œ ê²°ê³¼ë¬¼ ìë™ ê°ì§€)
            cd ~/division1d
            EXEC_FILE=$(find . -maxdepth 1 -type f -executable ! -name "*.so" ! -name "*.log" | head -1)

            if [ -z "$EXEC_FILE" ]; then
              echo "âŒ No executable file found!"
              ls -la ~/division1d
              exit 1
            fi

            EXEC_NAME=$(basename "$EXEC_FILE")
            echo "ğŸ¯ Found executable: $EXEC_NAME"

            # ì‹¤í–‰ ê¶Œí•œ í™•ì¸
            chmod +x "$EXEC_NAME"

            # Podman ì»¨í…Œì´ë„ˆë¡œ ì„œë²„ ì‹œì‘
            echo "ğŸš€ Starting Unity Dedicated Server in Podman..."
            sudo podman run -d --name unityds \
              --network host \
              -v ~/division1d:/app:Z \
              ubuntu:22.04 \
              bash -lc "cd /app && exec ./$EXEC_NAME -port 7777 -logFile /app/server.log"

            sleep 5

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            if sudo podman ps | grep -q unityds; then
              echo "âœ… Container started successfully"
              sudo podman ps | grep unityds
            else
              echo "âŒ Container failed to start!"
              sudo podman logs unityds || true
              exit 1
            fi

            # UDP 7777 í¬íŠ¸ í™•ì¸
            echo "ğŸ” Checking UDP port 7777..."
            if sudo ss -lunp | grep -q 7777; then
              echo "âœ… Server is listening on UDP 7777"
              sudo ss -lunp | grep 7777
            else
              echo "âš ï¸  Port 7777 not detected yet (server may still be initializing)"
            fi

            # ì„œë²„ ë¡œê·¸ í™•ì¸
            echo "ğŸ“Š Server logs (last 20 lines):"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            tail -n 20 ~/division1d/server.log 2>/dev/null || echo "Log file not created yet"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          EOF

      # 9. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: Deployment Summary
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… SERVER DEPLOYMENT COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‘¤ Deployed by: Snow0406"
          echo "ğŸ”§ Commit: ${{ github.sha }}"
          echo "ğŸ“¦ Build: Linux ARM64 Dedicated Server"
          echo "ğŸŒ Oracle VM: ${{ secrets.ORACLE_HOST }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # 10. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      - name: Deployment Failed
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ SERVER DEPLOYMENT FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Check the logs above for details"
          exit 1
